<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>iTest</title>
<style>
body { font-family: Arial; direction: rtl; background:#f5f5f5; padding:20px; }
h1 { text-align:center; font-size:48px; color:#0a4f0a; font-weight:bold; }
h2 { text-align:center; margin-bottom:20px; }
input { padding:8px; width:50%; font-size:18px; border-radius:8px; border:1px solid #ccc; }
button { padding:10px 20px; font-size:16px; background:#0a4f0a; color:#fff; border:none; border-radius:8px; cursor:pointer; }
table { width:100%; border-collapse:collapse; background:#fff; margin-top:20px; }
th, td { padding:12px; border:1px solid #ccc; text-align:center; }
th { background:#0a4f0a; color:white; }
</style>
</head>

<body>

<h1>iTest</h1>
<h2 id="exam-name"></h2>

<div style="text-align:center">
<input type="text" id="search" placeholder="بحث...">
</div>

<div style="text-align:center;margin-top:10px;">
<button id="download">تحميل Excel</button>
</div>

<table>
<thead>
<tr>
<th>العمود 1</th>
<th>العمود 2</th>
<th>العمود 3</th>
</tr>
</thead>
<tbody id="table-body"></tbody>
</table>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- CSV + Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// ===== Firebase =====
firebase.initializeApp({
  apiKey: "AIzaSyDwo_m6yDM5WAHfUOSbscMgYBOe0OLIdU4",
  authDomain: "itestlogs.firebaseapp.com",
  databaseURL: "https://itestlogs-default-rtdb.firebaseio.com",
  projectId: "itestlogs",
  storageBucket: "itestlogs.firebasestorage.app",
  messagingSenderId: "551369243108",
  appId: "1:551369243108:web:d675894ba6ed4a161f6ff1"
});
const db = firebase.database();

// ===== اسم الطالب (إجباري) =====
let user = "";
while(!user){
  user = prompt("اكتب اسمك:");
  if(!user) alert("يجب إدخال الاسم");
}

// سجل الدخول
db.ref("logs").push({
  name: user,
  action: "فتح الموقع",
  time: new Date().toLocaleString("ar-EG")
});

// ===== Google Sheet CSV =====
const csvUrl = "PUT_YOUR_CSV_LINK_HERE";

let rowsData = [];

// تحميل البيانات
Papa.parse(csvUrl, {
  download: true,
  complete: function(res){
    const rows = res.data.filter(r => r.length >= 3 && r[0] !== "");
    document.getElementById("exam-name").textContent = rows[0][0];
    rowsData = rows.slice(1);
    render(rowsData);
  }
});

function render(data){
  const body = document.getElementById("table-body");
  body.innerHTML = "";
  data.forEach(r=>{
    body.innerHTML += `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td></tr>`;
  });
}

// بحث
document.getElementById("search").oninput = e =>{
  const q = e.target.value.toLowerCase();
  render(rowsData.filter(r => r.join(" ").toLowerCase().includes(q)));
};

// تحميل Excel
document.getElementById("download").onclick = ()=>{
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet([["A","B","C"], ...rowsData]);
  XLSX.utils.book_append_sheet(wb, ws, "Students");
  XLSX.writeFile(wb,"students.xlsx");

  db.ref("logs").push({
    name: user,
    action: "تحميل Excel",
    time: new Date().toLocaleString("ar-EG")
  });
};
</script>

</body>
</html>

