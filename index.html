<!DOCTYPE html><html lang="ar">
<head>
<meta charset="UTF-8">
<title>iTest</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#f4f6f8;text-align:center;padding:20px}
h1{color:#006400;font-size:42px}
input{width:80%;max-width:400px;padding:12px;font-size:18px;margin-bottom:20px;border:2px solid #006400;border-radius:8px}
button{padding:10px 20px;font-size:16px;background:#006400;color:#fff;border:none;border-radius:8px;cursor:pointer;margin-bottom:20px}
table{width:95%;margin:auto;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ccc;padding:10px}
th{background:#e8f5e9}
</style>
</head>
<body>
<h1>iTest</h1>
<input id="search" placeholder="ابحث عن طالب...">
<br>
<button id="download">تحميل Excel</button>
<table>
<tbody id="tbody"></tbody>
</table><!-- Firebase --><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script><!-- Excel --><script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script><script>
// Firebase initialization
firebase.initializeApp({
  apiKey: "AIzaSyDwo_m6yDM5WAHfUOSbscMgYBOe0OLIdU4",
  authDomain: "itestlogs.firebaseapp.com",
  databaseURL: "https://itestlogs-default-rtdb.firebaseio.com",
  projectId: "itestlogs",
  storageBucket: "itestlogs.firebasestorage.app",
  messagingSenderId: "551369243108",
  appId: "1:551369243108:web:d675894ba6ed4a161f6ff1"
});
const db = firebase.database();

// Ask username
let user="";
while(!user){user=prompt('اكتب اسمك')}
db.ref('logs').push({name:user,action:'فتح الموقع',time:new Date().toLocaleString('ar')});

// CSV URL
const csvUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vQpvziG2pi3c-qHGIJuP2M5RxUXgkWtK_5I1oPxSRhcp8ml7Ty8b4JVP-OogglSp1ddcYh7WSsUvABV/pub?output=csv";
let students=[];

// Load CSV
fetch(csvUrl).then(r=>r.text()).then(text=>{
  const rows=text.trim().split('\n').map(r=>r.split(','));
  students=rows.slice(2); // كل ما في الأعمدة 1 و2 و3 سيعرض بدون تقييد
  render(students);
});

function render(data){
  const tb=document.getElementById('tbody');
  tb.innerHTML='';
  data.forEach(r=>{
    tb.innerHTML+=`<tr><td>${r[0]||''}</td><td>${r[1]||''}</td><td>${r[2]||''}</td></tr>`;
  });
}

// Search
document.getElementById('search').oninput=e=>{
  const v=e.target.value.toLowerCase();
  render(students.filter(r=>r.join(' ').toLowerCase().includes(v)));
};

// Download Excel
document.getElementById('download').onclick=()=>{
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(students);
  XLSX.utils.book_append_sheet(wb,ws,'Students');
  XLSX.writeFile(wb,'students.xlsx');
  db.ref('logs').push({name:user,action:'تحميل Excel',time:new Date().toLocaleString('ar')});
};
</script></body>
</html>
